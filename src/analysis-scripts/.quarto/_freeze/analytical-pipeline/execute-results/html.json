{
  "hash": "c23118d5207767fd10fa7ec685674049",
  "result": {
    "markdown": "---\ntitle: \"BY-COVID - WP5 - Baseline Use Case: SARS-CoV-2 vaccine effectiveness assessment\"\nsubtitle: \"Analytical pipeline\"\nformat: \n  html:\n    self-contained: true\ncode-fold: false\nalways_allow_html: yes\ntitle-block-banner: \"#27445C\"\n---\n\n::: {.cell}\n\n```{.r .cell-code}\n################\n### Metadata ###\n################\n\n# DATE LAST MODIFIED:\n# 19/09/2023\n\n# METADATA: \nif(FALSE) {\n  title      <- 'BY-COVID WP5.2 Baseline Use Case: SARS-CoV-2 vaccine effectiveness - analytical pipeline'\n  authors     <- list('Marjan Meurisse','Javier González-Galindo','Santiago Royo-Sierra','Francisco Estupiñán-Romero','Nina Van Goethem','Enrique Bernal-Delgado')\n  version    <- '1.0.2'\n  maintainer <- 'Marjan Meurisse'\n  email      <- 'Marjan.Meurisse@sciensano.be'\n  input      <- list('csv upload')\n  output     <- list('1_DQA.html','2_validation.html','3_imputation.html','4_matching.html','5_descriptive.html','6_survival-analysis.html','results-survival-analysis-<country>.xlsx')\n}\n\n################\n### Overview ###\n################\n\n# This analytical pipeline corresponds to BY-COVID WP5 T5.2 baseline use case on “SARS-CoV-2 Vaccine(s) effectiveness in preventing SARS-CoV-2 infection”\n\n# 0. General settings and loading of data\n#      -> Script: 0_global.R\n# 1. Data Quality Assessment (DQA)\n#      -> Script: 1_DQA.QMD\n#      -> Output: 1_DQA.html\n# 2. Validation\n#      -> Script: 2_validation.QMD\n#      -> Output: 2_validation.html\n# 3. Imputation of missing values\n#      -> Script: 3_imputation.QMD\n#      -> Output: 3_imputation.html\n# 4. Matching cases to controls (1:1) and assessing covariate balance after matching\n#      -> Script: 4_matching.QMD\n#      -> Output: 4_matching.html\n# 5. Descriptive analysis\n#      -> Script: 5_descriptives.R\n#      -> Output: 5_descriptive.html\n# 6. Survival analysis\n#      -> Script: 6_survival-analysis.R\n#      -> Output: 6_survival-analysis.html\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# 0. General settings and loading of data\n\nstart_global_time <- Sys.time()\n\nsource(\"./0_global.R\")\n\n# Remove log file if it already exists\nif (file.exists(log_file_path)) {\n  file.remove(log_file_path)\n}\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] TRUE\n```\n:::\n\n```{.r .cell-code}\n# Load data\ntryCatch({\n  f_load_data(create_db_tables = TRUE,\n               load_data = TRUE)\n}, error = function(err) {\n  print(paste(\"MY ERROR:  \",err))\n  knitr::knit_exit()\n})\n```\n:::\n\n\n## Data Quality Assessment\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 1. Data Quality Assessment (DQA)\n\nstart_DQA_time <- Sys.time()\n\n# Render the quarto document\ntryCatch({\n  quarto::quarto_render(\"./1_DQA.QMD\", output_file = \"1_DQA.html\")\n}, error = function(err) {\n  print(paste(\"MY ERROR:  \",err))\n})\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\u001b[31m\n\nprocessing file: 1_DQA.QMD\n\u001b[39m1/33                         \n2/33 [metadata]              \n3/33                         \n4/33 [unnamed-chunk-1]       \n5/33                         \n6/33 [general settings]      \n7/33                         \n8/33 [logging]               \n9/33                         \n10/33 [load data]             \n11/33                         \n12/33 [introduce]             \n13/33                         \n14/33 [dataset statistics]    \n15/33                         \n16/33 [variables]             \n17/33                         \n18/33 [classes]               \n19/33                         \n20/33 [missing data profile 1]\n21/33                         \n22/33 [missing data profile 2]\n23/33                         \n24/33 [missing data profile 3]\n25/33                         \n26/33 [alerts]                \n27/33                         \n28/33 [duplicates]            \n29/33                         \n30/33 [chunk]                 \n31/33                         \n32/33 [individual variables]  \n33/33                         \n\u001b[31moutput file: 1_DQA.knit.md\n\n\u001b[39m\u001b[31mWarning message:\nDatabase is garbage-collected, use dbDisconnect(con, shutdown=TRUE) or duckdb::duckdb_shutdown(drv) to avoid this. \n\u001b[39m\u001b[1mpandoc --output 1_DQA.html\u001b[22m\n  to: html\n  standalone: true\n  self-contained: true\n  section-divs: true\n  html-math-method: mathjax\n  wrap: none\n  default-image-extension: png\n  \n\u001b[1mmetadata\u001b[22m\n  document-css: false\n  link-citations: true\n  date-format: long\n  lang: en\n  title: 'BY-COVID - WP5 - Baseline Use Case: SARS-CoV-2 vaccine effectiveness'\n  subtitle: Data Quality Assessment (DQA)\n  editor: visual\n  always_allow_html: 'yes'\n  title-block-banner: '#27445C'\n  \nOutput created: ../../outputs/1_DQA.html\n```\n:::\n:::\n\n\n## Validation\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 2. Validation\n\nstart_validation_time <- Sys.time()\n\n# Render the quarto document\ntryCatch({\n  quarto::quarto_render(\"./2_validation.QMD\", output_file = \"2_validation.html\")\n}, error = function(err) {\n  print(paste(\"MY ERROR:  \",err))\n})\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\u001b[31m\n\nprocessing file: 2_validation.QMD\n\u001b[39m1/25                            \n2/25 [metadata]                 \n3/25                            \n4/25 [unnamed-chunk-1]          \n5/25                            \n6/25 [general settings]         \n7/25                            \n8/25 [logging]                  \n9/25                            \n10/25 [load data]                \n11/25                            \n12/25 [validation rules]         \n13/25                            \n14/25 [validation table]         \n15/25                            \n16/25 [validation plot 1]        \n17/25                            \n18/25 [validation plot 2]        \n19/25                            \n20/25 [violating essential rules]\n21/25                            \n22/25 [save violated]            \n23/25                            \n24/25 [print violating rules]    \n25/25                            \n\u001b[31moutput file: 2_validation.knit.md\n\n\u001b[39m\u001b[31mWarning message:\nDatabase is garbage-collected, use dbDisconnect(con, shutdown=TRUE) or duckdb::duckdb_shutdown(drv) to avoid this. \n\u001b[39m\u001b[31mWarning messages:\n1: Database is garbage-collected, use dbDisconnect(con, shutdown=TRUE) or duckdb::duckdb_shutdown(drv) to avoid this. \n2: Database is garbage-collected, use dbDisconnect(con, shutdown=TRUE) or duckdb::duckdb_shutdown(drv) to avoid this. \n\u001b[39m\u001b[1mpandoc --output 2_validation.html\u001b[22m\n  to: html\n  standalone: true\n  self-contained: true\n  section-divs: true\n  html-math-method: mathjax\n  wrap: none\n  default-image-extension: png\n  \n\u001b[1mmetadata\u001b[22m\n  document-css: false\n  link-citations: true\n  date-format: long\n  lang: en\n  title: 'BY-COVID - WP5 - Baseline Use Case: SARS-CoV-2 vaccine effectiveness assessment'\n  subtitle: Validation\n  editor: visual\n  always_allow_html: 'yes'\n  title-block-banner: '#27445C'\n  \nOutput created: ../../outputs/2_validation.html\n```\n:::\n:::\n\n\n## Imputation of missing values\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 3. Imputation of missing values\n\nstart_imputation_time <- Sys.time()\n\n# Render the quarto document\ntryCatch({\n  quarto::quarto_render(\"./3_imputation.QMD\", output_file = \"3_imputation.html\")\n}, error = function(err) {\n  print(paste(\"MY ERROR:  \",err))\n})\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\u001b[31m\n\nprocessing file: 3_imputation.QMD\n\u001b[39m1/29                           \n2/29 [metadata]                \n3/29                           \n4/29 [general settings]        \n5/29                           \n6/29 [logging]                 \n7/29                           \n8/29 [load data]               \n9/29                           \n10/29 [missing values map]      \n11/29                           \n12/29 [missing data matrix]     \n13/29                           \n14/29 [variable status 1]       \n15/29                           \n16/29 [variable status 2]       \n17/29                           \n18/29 [save variable status]    \n19/29                           \n20/29 [listwise deletion]       \n21/29                           \n22/29 [imputation]              \n23/29                           \n24/29 [imputation process print]\n25/29                           \n26/29 [plot imputation]         \n27/29                           \n28/29 [print listwise deletion] \n29/29                           \n\u001b[31moutput file: 3_imputation.knit.md\n\n\u001b[39m\u001b[31mWarning messages:\n1: Database is garbage-collected, use dbDisconnect(con, shutdown=TRUE) or duckdb::duckdb_shutdown(drv) to avoid this. \n2: Database is garbage-collected, use dbDisconnect(con, shutdown=TRUE) or duckdb::duckdb_shutdown(drv) to avoid this. \n3: Database is garbage-collected, use dbDisconnect(con, shutdown=TRUE) or duckdb::duckdb_shutdown(drv) to avoid this. \n\u001b[39m\u001b[31mWarning message:\nDatabase is garbage-collected, use dbDisconnect(con, shutdown=TRUE) or duckdb::duckdb_shutdown(drv) to avoid this. \n\u001b[39m\u001b[1mpandoc --output 3_imputation.html\u001b[22m\n  to: html\n  standalone: true\n  self-contained: true\n  section-divs: true\n  html-math-method: mathjax\n  wrap: none\n  default-image-extension: png\n  \n\u001b[1mmetadata\u001b[22m\n  document-css: false\n  link-citations: true\n  date-format: long\n  lang: en\n  title: 'BY-COVID - WP5 - Baseline Use Case: SARS-CoV-2 vaccine effectiveness assessment'\n  subtitle: Imputation of missing values\n  editor: visual\n  always_allow_html: 'yes'\n  title-block-banner: '#27445C'\n  \nOutput created: ../../outputs/3_imputation.html\n```\n:::\n:::\n\n\n## Matching\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 4. Matching cases to controls (1:1) and assessing covariate balance after matching\n\nstart_matching_time <- Sys.time()\n\n# Render the quarto document\ntryCatch({\n  quarto::quarto_render(\"./4_matching.QMD\", output_file = \"4_matching.html\")\n}, error = function(err) {\n  print(paste(\"MY ERROR:  \",err))\n})\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\u001b[31m\n\nprocessing file: 4_matching.QMD\n\u001b[39m1/31                            \n2/31 [metadata]                 \n3/31                            \n4/31 [general settings]         \n5/31                            \n6/31 [logging]                  \n7/31                            \n8/31 [matching]                 \n9/31                            \n10/31 [load data]                \n11/31                            \n12/31 [matchit prior]            \n13/31                            \n14/31 [matchit after]            \n15/31                            \n16/31 [SMD prior matching]       \n17/31                            \n18/31 [SMD prior matching plot]  \n19/31                            \n20/31 [SMD prior matching plot 2]\n21/31                            \n22/31 [SMD after matching]       \n23/31                            \n24/31 [SMD after matching plot]  \n25/31                            \n26/31 [SMD after matching plot 2]\n27/31                            \n28/31 [plot ps before]           \n29/31                            \n30/31 [plot ps after]            \n31/31                            \n\u001b[31moutput file: 4_matching.knit.md\n\n\u001b[39m\u001b[31mThere were 12 warnings (use warnings() to see them)\n\u001b[39m\u001b[1mpandoc --output 4_matching.html\u001b[22m\n  to: html\n  standalone: true\n  self-contained: true\n  section-divs: true\n  html-math-method: mathjax\n  wrap: none\n  default-image-extension: png\n  \n\u001b[1mmetadata\u001b[22m\n  document-css: false\n  link-citations: true\n  date-format: long\n  lang: en\n  title: 'BY-COVID - WP5 - Baseline Use Case: COVID-19 vaccine effectiveness assessment'\n  subtitle: 'Matching cases to controls (1:1) and assessing covariate balance after matching'\n  editor: visual\n  always_allow_html: 'yes'\n  title-block-banner: '#27445C'\n  \nOutput created: ../../outputs/4_matching.html\n```\n:::\n:::\n\n\n## Descriptive analyses\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 5. Descriptive analysis\n\nstart_descriptive_time <- Sys.time()\n\n# Render the quarto document\ntryCatch({\n  quarto::quarto_render(\"./5_descriptives.QMD\", output_file = \"5_descriptive.html\")\n}, error = function(err) {\n  print(paste(\"MY ERROR:  \",err))\n})\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\u001b[31m\n\nprocessing file: 5_descriptives.QMD\n\u001b[39m1/51                                                       \n2/51 [metadata]                                            \n3/51                                                       \n4/51 [general settings]                                    \n5/51                                                       \n6/51 [logging]                                             \n7/51                                                       \n8/51 [load data]                                           \n9/51                                                       \n10/51 [periods]                                             \n11/51                                                       \n12/51 [create consort graph]                                \n13/51                                                       \n14/51 [plot consort graph]                                  \n15/51                                                       \n16/51 [table 1 un-matched]                                  \n17/51                                                       \n18/51 [table 1 matched]                                     \n19/51                                                       \n20/51 [plot vaccination over time]                          \n21/51                                                       \n22/51 [plot vaccination over time by vaccination schedule]  \n23/51                                                       \n24/51 [plot vaccination over time by vaccination schedule 2]\n25/51                                                       \n26/51 [tables]                                              \n27/51                                                       \n28/51 [print table un-matched start population]             \n29/51                                                       \n30/51 [print table un-matched eligible population]          \n31/51                                                       \n32/51 [print table matched population]                      \n33/51                                                       \n34/51 [survival in un-matched population]                   \n35/51                                                       \n36/51 [survival not matched and simple model]               \n37/51                                                       \n38/51 [summary survival not matched and simple model]       \n39/51                                                       \n40/51 [survival plot not matched and simple model]          \n41/51                                                       \n42/51 [cumulative events plot not matched and simple model] \n43/51                                                       \n44/51 [survival cumulative events table]                    \n45/51                                                       \n46/51 [survival not matched and complex model]              \n47/51                                                       \n48/51 [summary survival not matched and complex model]      \n49/51                                                       \n50/51 [survival plot not matched and complex model]         \n51/51                                                       \n\u001b[31moutput file: 5_descriptives.knit.md\n\n\u001b[39m\u001b[31mWarning messages:\n1: Database is garbage-collected, use dbDisconnect(con, shutdown=TRUE) or duckdb::duckdb_shutdown(drv) to avoid this. \n2: Database is garbage-collected, use dbDisconnect(con, shutdown=TRUE) or duckdb::duckdb_shutdown(drv) to avoid this. \n3: Database is garbage-collected, use dbDisconnect(con, shutdown=TRUE) or duckdb::duckdb_shutdown(drv) to avoid this. \n4: Database is garbage-collected, use dbDisconnect(con, shutdown=TRUE) or duckdb::duckdb_shutdown(drv) to avoid this. \n5: Database is garbage-collected, use dbDisconnect(con, shutdown=TRUE) or duckdb::duckdb_shutdown(drv) to avoid this. \n\u001b[39m\u001b[1mpandoc --output 5_descriptive.html\u001b[22m\n  to: html\n  standalone: true\n  self-contained: true\n  section-divs: true\n  html-math-method: mathjax\n  wrap: none\n  default-image-extension: png\n  \n\u001b[1mmetadata\u001b[22m\n  document-css: false\n  link-citations: true\n  date-format: long\n  lang: en\n  title: 'BY-COVID - WP5 - Baseline Use Case: COVID-19 vaccine effectiveness assessment'\n  subtitle: Descriptive analyses\n  editor: visual\n  always_allow_html: 'yes'\n  title-block-banner: '#27445C'\n  \nOutput created: ../../outputs/5_descriptive.html\n```\n:::\n:::\n\n\n## Survival analysis\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 6. Survival analysis\n\nstart_survival_time <- Sys.time()\n\n# Render the quarto document\ntryCatch({\n  quarto::quarto_render(\"./6_survival-analysis.QMD\", output_file = \"6_survival-analysis.html\")\n}, error = function(err) {\n  print(paste(\"MY ERROR:  \",err))\n})\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\u001b[31m\n\nprocessing file: 6_survival-analysis.QMD\n\u001b[39m1/77                                                   \n2/77 [metadata]                                        \n3/77                                                   \n4/77 [general settings]                                \n5/77                                                   \n6/77 [logging]                                         \n7/77                                                   \n8/77 [load data]                                       \n9/77                                                   \n10/77 [survival]                                        \n11/77                                                   \n12/77 [survival plot]                                   \n13/77                                                   \n14/77 [survival plot 2]                                 \n15/77                                                   \n16/77 [cumulative events plot]                          \n17/77                                                   \n18/77 [cumulative events plot 2]                        \n19/77                                                   \n20/77 [x-time survival]                                 \n21/77                                                   \n22/77 [median survival time]                            \n23/77                                                   \n24/77 [coxph HR]                                        \n25/77                                                   \n26/77 [hazard ratio]                                    \n27/77                                                   \n28/77 [coxph model fit]                                 \n29/77                                                   \n30/77 [rmst2]                                           \n31/77                                                   \n32/77 [RMST and RMTL]                                   \n33/77                                                   \n34/77 [average treatment effect]                        \n35/77                                                   \n36/77 [survival plot by vaccination schedule]           \n37/77                                                   \n38/77 [survival plot by vaccination schedule 2]         \n39/77                                                   \n40/77 [cumulative incidence by vaccination schedule]    \n41/77                                                   \n42/77 [cumulative incidence by vaccination schedule 2]  \n43/77                                                   \n44/77 [coxph HR by vaccination schedule]                \n45/77                                                   \n46/77 [hazard ratio by vaccination schedule]            \n47/77                                                   \n48/77 [coxph model by vaccination schedule fit]         \n49/77                                                   \n50/77 [rmst2 by vaccination schedele]                   \n51/77                                                   \n52/77 [RMST and RMTL by vaccination schedele]           \n53/77                                                   \n54/77 [average treatment effect by vaccination schedele]\n55/77                                                   \n56/77 [survival plot by residence area]                 \n57/77                                                   \n58/77 [survival plot by residence area 2]               \n59/77                                                   \n60/77 [cumulative incidence by residence area]          \n61/77                                                   \n62/77 [cumulative incidence by residence area 2]        \n63/77                                                   \n64/77 [coxph HR by residence area]                      \n65/77                                                   \n66/77 [hazard ratio by residence area]                  \n67/77                                                   \n68/77 [coxph model by residence area fit]               \n69/77                                                   \n70/77 [rmst2 by residence area]                         \n71/77                                                   \n72/77 [RMST and RMTL by residence area]                 \n73/77                                                   \n74/77 [average treatment effect by residence area]      \n75/77                                                   \n76/77 [saving results for meta-analysis]                \n77/77                                                   \n\u001b[31moutput file: 6_survival-analysis.knit.md\n\n\u001b[39m\u001b[31mWarning message:\nDatabase is garbage-collected, use dbDisconnect(con, shutdown=TRUE) or duckdb::duckdb_shutdown(drv) to avoid this. \n\u001b[39m\u001b[1mpandoc --output 6_survival-analysis.html\u001b[22m\n  to: html\n  standalone: true\n  self-contained: true\n  section-divs: true\n  html-math-method: mathjax\n  wrap: none\n  default-image-extension: png\n  \n\u001b[1mmetadata\u001b[22m\n  document-css: false\n  link-citations: true\n  date-format: long\n  lang: en\n  title: 'BY-COVID - WP5 - Baseline Use Case: COVID-19 vaccine effectiveness assessment'\n  subtitle: Survival analysis\n  editor: visual\n  always_allow_html: 'yes'\n  title-block-banner: '#27445C'\n  \nOutput created: ../../outputs/6_survival-analysis.html\n```\n:::\n\n```{.r .cell-code}\n# Copy the results for meta-analysis (xlsx file)\n\nfile_xlsx <- grep(\".xlsx\", list.files(path=\"./\", full.names = TRUE, recursive = TRUE), value = TRUE)\nfile.copy(from = file_xlsx,\n              to = paste0(\"../../outputs/\",sub('.*./', '', file_xlsx)))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] FALSE\n```\n:::\n\n```{.r .cell-code}\nfile.remove(file_xlsx)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] TRUE\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Assess the runtime\n\ninfo(logger,\n  paste0(\"\n========================================================================================\n\",\n\"Runtime\",\"\n\",\n\"========================================================================================\n  \"))\n\nend_time <- Sys.time()\n\ninfo(logger_simple, paste0(\"Overall runtime: \", round(difftime(end_time,start_global_time)[[1]],2), \" \", units(difftime(end_time,start_global_time))))\ninfo(logger_simple, paste0(\"Runtime 0_global.R: \", round(difftime(start_DQA_time,start_global_time)[[1]],2), \" \", units(difftime(start_DQA_time,start_global_time))))\ninfo(logger_simple, paste0(\"Runtime 1_DQA.QMD: \", round(difftime(start_validation_time,start_DQA_time)[[1]],2), \" \", units(difftime(start_validation_time,start_DQA_time))))\ninfo(logger_simple, paste0(\"Runtime 2_validation.QMD: \", round(difftime(start_imputation_time,start_validation_time)[[1]],2), \" \", units(difftime(start_imputation_time,start_validation_time))))\ninfo(logger_simple, paste0(\"Runtime 3_imputation.QMD: \", round(difftime(start_matching_time,start_imputation_time)[[1]],2), \" \", units(difftime(start_matching_time,start_imputation_time))))\ninfo(logger_simple, paste0(\"Runtime 4_matching.QMD: \", round(difftime(start_descriptive_time,start_matching_time)[[1]],2), \" \", units(difftime(start_descriptive_time,start_matching_time))))\ninfo(logger_simple, paste0(\"Runtime 5_descriptives.QMD: \", round(difftime(start_survival_time,start_descriptive_time)[[1]],2), \" \", units(difftime(start_survival_time,start_descriptive_time))))\ninfo(logger_simple, paste0(\"Runtime 6_survival-analysis.QMD: \", round(difftime(end_time,start_survival_time)[[1]],2), \" \", units(difftime(end_time,start_survival_time))))\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}